#!/bin/bash

set -e

# This script is a starting point to setup your application.
# Add necessary setup steps to this file.

echo "== Installing dependencies =="
gem install bundler --conservative
bundle check || bundle install

# Install JavaScript dependencies if using Yarn
bin/yarn

echo "== Preparing database =="
docker-compose up -d db

# Wait for db to be up and running
until docker-compose exec db psql -U postgres -c "SELECT 'OK' AS db_ready" -d postgres; do sleep 1; done

docker-compose run --rm web rake db:create db:schema:load db:migrate db:seed

echo "== Removing old logs and tempfiles =="
bin/rails log:clear tmp:clear

echo "== Preparing test environment =="
RAILS_ENV=test bundle exec rake db:create db:migrate

echo "== Starting application stack =="
docker-compose up -d
